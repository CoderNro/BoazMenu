name: Build DMT139z Dylib

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest  # ‚úÖ OK, d√πng macOS m·ªõi nh·∫•t
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4  # ‚úÖ N√¢ng t·ª´ v3 l√™n v4
      
    - name: Setup Theos
      run: |
        sudo mkdir -p /opt/theos
        sudo git clone --recursive https://github.com/theos/theos.git /opt/theos
        echo "THEOS=/opt/theos" >> $GITHUB_ENV
        echo "PATH=/opt/theos/bin:$PATH" >> $GITHUB_ENV  # ‚úÖ Th√™m PATH
        
    - name: Install dependencies
      run: |
        brew install ldid xz
        # ‚ùå B·ªè d√≤ng nicify v√¨ n√≥ kh√¥ng c·∫ßn thi·∫øt
        
    - name: Verify files
      run: |
        ls -la
        # Ki·ªÉm tra xem c√≥ Makefile kh√¥ng
        test -f Makefile || echo "‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y Makefile"
        
    - name: Build dylib
      run: |
        make clean
        make
        # make package  # ‚ùå T·∫°m th·ªùi comment n·∫øu ch∆∞a c√≥ c·∫•u h√¨nh package
        
    - name: Find dylib files
      run: |
        echo "üîç T√¨m ki·∫øm file .dylib..."
        find . -name "*.dylib" -type f
        find . -name "*.deb" -type f
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4  # ‚úÖ N√¢ng t·ª´ v3 l√™n v4
      with:
        name: DMT139z-Build
        path: |
          **/*.dylib
          **/*.deb
          **/*.plist
        retention-days: 30
        if-no-files-found: warn  # ‚úÖ C·∫£nh b√°o n·∫øu kh√¥ng t√¨m th·∫•y file
        - name: Prepare layout
  run: |
    mkdir -p layout/Library/MobileSubstrate/DynamicLibraries
    cp DMT139z.plist layout/Library/MobileSubstrate/DynamicLibraries/ || true
